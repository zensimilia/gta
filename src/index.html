<!DOCTYPE html>
<html>

<head>
  <title>GTA RADIO</title>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="noindex, nofollow" />

  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
  <script src="https://cdn.jsdelivr.net/npm/flickity@3.0.0/dist/flickity.pkgd.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.4/howler.core.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/alpinejs/3.10.5/cdn.min.js" defer></script>

  <link rel="icon" type="image/png" href="static/favicon.png" />

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flickity@3.0.0/css/flickity.min.css" />

  <style>
    [x-cloak] {
      display: none !important;
    }
  </style>

  <style type="text/tailwindcss">
    html,
      body {
        @apply h-full w-full;
        @apply text-white bg-black;
      }
      .flickity-viewport {
        @apply !h-full;
      }
      .flickity-slider {
        @apply flex items-center;
      }
      .flickity-cell.is-selected img {
        @apply opacity-100 scale-100;
      }
  </style>
</head>

<body>
  <div x-data="player" x-cloak class="w-full h-full relative">
    <div x-ref="carousel" class="relative h-full">
      <template x-for="(radio, index) in data" :key="radio.id">
        <div class="cell mx-4 w-2/5 sm:w-1/5 cursor-pointer text-center h-auto">
          <img :src="radio.logo" :alt="radio.title"
            :class="{'animate-pulse': carousel && carousel.selectedIndex == index && (isMuted || !station )}"
            class="mx-auto transition-all duration-300 opacity-50 scale-75" x-show="carousel" />
        </div>
      </template>
    </div>

    <div x-show="isLoading" x-transition class="absolute top-1/2 w-full px-8">
      <p class="text-center animate-pulse uppercase text-xl">Loading</p>
    </div>

    <div class="absolute w-2/6 left-0 top-0 h-full bg-gradient-to-r from-black to-transparent z-40 pointer-events-none">
    </div>
    <div
      class="absolute w-2/6 right-0 top-0 h-full bg-gradient-to-l from-black to-transparent z-40 pointer-events-none">
    </div>
    <div
      class="absolute right-0 left-0 bottom-0 px-8 mx-auto max-w-max md:max-w-md text-xs/3 tracking-tight text-center text-white/20 mb-4 z-50 pointer-events-none">
      <p class="mb-2">
        All logos, brand names, musical compositions, sound recordings, and other audio materials remain the property
        of their respective rights holders and are protected by copyright and related rights. Playback is provided
        "as is" and, where applicable, under appropriate licenses/permissions.
      </p>
      <p>
        <span x-text="new Date().getFullYear()"></span> &copy; Di M Dub. Some rights reserved. v<span
          x-text="version"></span>
      </p>
    </div>
  </div>
</body>

<script>
  function player() {
    return {
      data: null,
      station: null,
      tuneFx: null,
      tuneFxId: null,
      currentStream: null,
      carousel: null,
      isLoading: false,
      isMuted: false,
      shuffleInitial: true,
      dataURL: "data.json",
      tuneFxURL: "static/tune.aac",
      version: "1.1.6",

      init() {
        this.fetchData();
        this.tuneFx = new Howl({
          src: [this.tuneFxURL],
          loop: true,
          preload: true,
          autoplay: false,
          onfade: () => {
            this.tuneFx.pause(this.tuneFxId);
            this.tuneFx.volume(1, this.tuneFxId);
          },
          onplay: () => {
            this.tuneFx.seek(Math.trunc(Date.now() / 1000 % this.tuneFx.duration()), this.tuneFxId);
          }
        });
      },

      toggleMute() {
        this.isMuted = !this.isMuted;
        Howler.mute(this.isMuted);
      },

      streamLoad(stream) {
        if (this.currentStream && this.currentStream.id == stream.id) return this.toggleMute();
        if (this.station) this.station.unload();

        if (!this.tuneFxId) this.tuneFxId = this.tuneFx.play();
        else this.tuneFx.play(this.tuneFxId);

        this.station = new Howl({
          src: [stream.file],
          html5: true,
          loop: true,
          onplay: () => {
            this.station.seek(Math.trunc(Date.now() / 1000 % this.station.duration()));
            this.tuneFx.fade(1, 0, 2000, this.tuneFxId);
          },
          onload: () => {
            this.station.play();
          },
          onloaderror: () => {
            this.tuneFx.fade(1, 0, 2000, this.tuneFxId);
            this.station = null;
            this.currentStream = null;
          }
        });
        this.currentStream = stream;
        this.setMediaMetadata(stream);
      },

      setMediaMetadata(data) {
        navigator.mediaSession.metadata = new MediaMetadata({
          title: data.title,
          artist: data.game,
          artwork: [{ src: data.logo }],
        });
        document.querySelector("link[rel*='icon']").href = this.currentStream.logo;
      },

      fetchData() {
        this.isLoading = true;
        fetch(this.dataURL)
          .then((res) => res.json())
          .then((data) => {
            this.data = data;
            this.initCarousel();
          })
          .finally(() => (this.isLoading = false));
      },

      async initCarousel() {
        await this.$nextTick();
        this.carousel = new Flickity(this.$refs.carousel, {
          initialIndex: this.shuffleInitial ? Math.floor(Math.random() * this.data.length) : 0,
          wrapAround: true,
          cellSelector: ".cell",
          pageDots: false,
          prevNextButtons: false,
          selectedAttraction: 0.01,
          friction: 0.2,
          dragThreshold: 10,
        });
        this.$refs.carousel.focus();
        this.carousel.on("change", (index) => {
          this.streamLoad(this.data[index]);
        });
        this.carousel.on("staticClick", (event, pointer, cellElement, cellIndex) => {
          if (!cellElement) return;
          if (cellIndex == this.carousel.selectedIndex) return this.streamLoad(this.data[cellIndex]);
          this.carousel.select(cellIndex);
        });
      },
    };
  }
</script>

</html>
